<div class="dashboard-container">
  <!-- Modern Header with Welcome Message -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="welcome-section">
        <h1 class="dashboard-title">{{ dashboardTitle() }}</h1>
        <p class="dashboard-subtitle">Добро пожаловать в панель управления</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" routerLink="/orders" class="quick-action-btn">
          <mat-icon>add</mat-icon>
          Новый заказ
        </button>
        <button mat-icon-button [matMenuTriggerFor]="refreshMenu" class="refresh-btn">
          <mat-icon>refresh</mat-icon>
        </button>
        <mat-menu #refreshMenu="matMenu">
          <button mat-menu-item (click)="refreshData()">
            <mat-icon>refresh</mat-icon>
            Обновить данные
          </button>
          <button mat-menu-item (click)="exportDashboard()">
            <mat-icon>download</mat-icon>
            Экспорт отчета
          </button>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="isLoading()" class="loading-container">
    <div class="loading-content">
      <mat-spinner diameter="50"></mat-spinner>
      <h3>Загрузка данных панели управления...</h3>
      <p>Пожалуйста, подождите</p>
    </div>
  </div>

  <div *ngIf="!isLoading()" class="dashboard-content">
    <!-- Orders Statistics -->
    <section class="stats-section">
      <div class="section-header">
        <h2>
          <mat-icon>dashboard</mat-icon>
          Обзор заказов
        </h2>
        <div class="section-actions">
          <button mat-icon-button (click)="toggleStatsView()" matTooltip="Переключить вид">
            <mat-icon>{{ showDetailedStats() ? 'view_module' : 'view_list' }}</mat-icon>
          </button>
        </div>
      </div>
      <div class="stats-grid">
        <mat-card class="stat-card primary">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">assignment</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().total }}</h3>
                <p>Всего заказов</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">trending_up</mat-icon>
                  <span class="trend-text">+12% за месяц</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card warning">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">schedule</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().waiting }}</h3>
                <p>{{ getStatusDisplay('waiting') }}</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">schedule</mat-icon>
                  <span class="trend-text">Ожидают обработки</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card info">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">assignment_ind</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().assigned }}</h3>
                <p>{{ getStatusDisplay('assigned') }}</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">person</mat-icon>
                  <span class="trend-text">Назначены инженерам</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card processing">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">person_add</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().processing }}</h3>
                <p>{{ getStatusDisplay('processing') }}</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">work</mat-icon>
                  <span class="trend-text">В процессе выполнения</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card working">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">build</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().working }}</h3>
                <p>{{ getStatusDisplay('working') }}</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">engineering</mat-icon>
                  <span class="trend-text">Активно выполняются</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card review">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">visibility</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().review }}</h3>
                <p>{{ getStatusDisplay('review') }}</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">search</mat-icon>
                  <span class="trend-text">На проверке</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card success">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-wrapper">
                <mat-icon class="stat-icon">check_circle</mat-icon>
              </div>
              <div class="stat-info">
                <h3>{{ orderStats().completed }}</h3>
                <p>{{ getStatusDisplay('completed') }}</p>
                <div class="stat-trend" *ngIf="showDetailedStats()">
                  <mat-icon class="trend-icon">done_all</mat-icon>
                  <span class="trend-text">Успешно завершены</span>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <!-- Orders by Source Statistics -->
    <section class="stats-section">
      <h2>Заказы по источникам</h2>
      <div class="stats-grid source-stats">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">touch_app</mat-icon>
              <div class="stat-info">
                <h3>{{ orderStats().bySource.manual }}</h3>
                <p>{{ getSourceDisplay('manual') }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">settings</mat-icon>
              <div class="stat-info">
                <h3>{{ orderStats().bySource.automatic }}</h3>
                <p>{{ getSourceDisplay('automatic') }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">email</mat-icon>
              <div class="stat-info">
                <h3>{{ orderStats().bySource.email }}</h3>
                <p>{{ getSourceDisplay('email') }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">api</mat-icon>
              <div class="stat-info">
                <h3>{{ orderStats().bySource.api }}</h3>
                <p>{{ getSourceDisplay('api') }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <!-- User Statistics (Admin/Manager only) -->
    <!-- <section *ngIf="showUserStats()" class="stats-section">
      <h2>Управление пользователями</h2>
      <div class="stats-grid">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">people</mat-icon>
              <div class="stat-info">
                <h3>{{ userStats().totalUsers }}</h3>
                <p>Всего пользователей</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">person</mat-icon>
              <div class="stat-info">
                <h3>{{ userStats().activeUsers }}</h3>
                <p>Активные пользователи</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">person_add</mat-icon>
              <div class="stat-info">
                <h3>{{ userStats().newUsersThisMonth }}</h3>
                <p>Новых в этом месяце</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section> -->

    <!-- Earnings Statistics -->
    <section *ngIf="showEarningsStats()" class="stats-section">
      <!-- <h2>Обзор доходов</h2>
      <div class="earnings-comparison">
        <mat-card class="earnings-card">
          <mat-card-content>
            <div class="earnings-content">
              <div class="earnings-current">
                <h3>Текущий месяц</h3>
                <div *ngIf="earningsStats().currentMonth" class="earnings-details">
                  <p class="earnings-amount">${{ earningsStats().currentMonth!.totalEarnings }}</p>
                  <p class="earnings-orders">
                    {{ earningsStats().currentMonth!.completedOrders }} заказов
                  </p>
                </div>
                <div *ngIf="!earningsStats().currentMonth" class="no-data">
                  <p>Данные недоступны</p>
                </div>
              </div>

              <div
                class="earnings-growth"
                *ngIf="earningsStats().currentMonth && earningsStats().previousMonth"
              >
                <mat-icon [style.color]="getGrowthColor(earningsStats().growth)">
                  {{ getGrowthIcon(earningsStats().growth) }}
                </mat-icon>
                <span [style.color]="getGrowthColor(earningsStats().growth)">
                  {{ earningsStats().growth >= 0 ? '+' : ''
                  }}{{ earningsStats().growth.toFixed(1) }}%
                </span>
                <p>по сравнению с прошлым месяцем</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div> -->
    </section>

    <!-- Engineer Detailed Statistics (только для инженеров - роль USER) -->
    <section
      *ngIf="showEngineerStats() && engineerStats()"
      class="stats-section engineer-stats-section"
    >
      <h2>Моя статистика за {{ engineerStats()?.month }}/{{ engineerStats()?.year }}</h2>

      <div class="stats-grid">
        <!-- Карточка с часами работы -->
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">schedule</mat-icon>
              <div class="stat-info">
                <h3>{{ formatHours(engineerStats()?.totalHours || 0) }}</h3>
                <p>Всего отработано</p>
              </div>
            </div>
            <div class="stat-details">
              <div class="detail-item">
                <span class="detail-label">Обычные часы:</span>
                <span class="detail-value">{{
                  formatHours(engineerStats()?.regularHours || 0)
                }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Переработка:</span>
                <span class="detail-value">{{
                  formatHours(engineerStats()?.overtimeHours || 0)
                }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Карточка с заработком -->
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">payments</mat-icon>
              <div class="stat-info">
                <h3>{{ formatAmount(engineerStats()?.totalEarnings || 0) }}</h3>
                <p>Всего заработано</p>
              </div>
            </div>
            <div class="stat-details">
              <div class="detail-item">
                <span class="detail-label">Обязательная часть:</span>
                <span class="detail-value">{{
                  formatAmount(engineerStats()?.baseEarnings || 0)
                }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">За переработку:</span>
                <span class="detail-value">{{
                  formatAmount(engineerStats()?.overtimeEarnings || 0)
                }}</span>
              </div>
              <div class="detail-item" *ngIf="engineerStats()?.bonusEarnings">
                <span class="detail-label">Бонусы:</span>
                <span class="detail-value">{{
                  formatAmount(engineerStats()?.bonusEarnings || 0)
                }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Карточка с заказами -->
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">assignment_turned_in</mat-icon>
              <div class="stat-info">
                <h3>{{ engineerStats()?.completedOrders || 0 }}</h3>
                <p>Выполнено заказов</p>
              </div>
            </div>
            <div class="stat-details">
              <div class="detail-item">
                <span class="detail-label">Среднее время на заказ:</span>
                <span class="detail-value">{{
                  formatHours(engineerStats()?.averageHoursPerOrder || 0)
                }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Карточка с динамикой -->
        <mat-card class="stat-card" *ngIf="engineerStats()?.previousMonthEarnings">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon
                class="stat-icon"
                [style.color]="getGrowthColor(engineerStats()?.earningsGrowth || 0)"
              >
                {{ getGrowthIcon(engineerStats()?.earningsGrowth || 0) }}
              </mat-icon>
              <div class="stat-info">
                <h3 [style.color]="getGrowthColor(engineerStats()?.earningsGrowth || 0)">
                  {{ (engineerStats()?.earningsGrowth || 0) >= 0 ? '+' : ''
                  }}{{ (engineerStats()?.earningsGrowth || 0).toFixed(1) }}%
                </h3>
                <p>Рост заработка</p>
              </div>
            </div>
            <div class="stat-details">
              <div class="detail-item">
                <span class="detail-label">Прошлый месяц:</span>
                <span class="detail-value">{{
                  formatAmount(engineerStats()?.previousMonthEarnings || 0)
                }}</span>
              </div>
              <div class="detail-item" *ngIf="engineerStats()?.previousMonthHours">
                <span class="detail-label">Изменение часов:</span>
                <span
                  class="detail-value"
                  [style.color]="getGrowthColor(engineerStats()?.hoursGrowth || 0)"
                >
                  {{ (engineerStats()?.hoursGrowth || 0) >= 0 ? '+' : ''
                  }}{{ (engineerStats()?.hoursGrowth || 0).toFixed(1) }}%
                </span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <!-- Admin Engineer Statistics -->
    <section
      *ngIf="showAdminEngineerStats() && adminEngineerStats()"
      class="stats-section admin-engineer-stats-section"
    >
      <h2>
        Статистика по инженерам за {{ adminEngineerStats()?.month }}/{{
          adminEngineerStats()?.year
        }}
      </h2>

      <!-- Summary Cards -->
      <div class="stats-grid summary-cards">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">attach_money</mat-icon>
              <div class="stat-info">
                <h3>{{ formatAmount(adminEngineerStats()?.totals?.organizationPayments || 0) }}</h3>
                <p>Оплата от организаций</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">payments</mat-icon>
              <div class="stat-info">
                <h3>{{ formatAmount(adminEngineerStats()?.totals?.engineerEarnings || 0) }}</h3>
                <p>Выплачено инженерам</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card profit-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">trending_up</mat-icon>
              <div class="stat-info">
                <h3>{{ formatAmount(adminEngineerStats()?.totals?.profit || 0) }}</h3>
                <p>Прибыль ({{ (adminEngineerStats()?.totals?.profitMargin || 0).toFixed(1) }}%)</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-content">
              <mat-icon class="stat-icon">assignment_turned_in</mat-icon>
              <div class="stat-info">
                <h3>{{ adminEngineerStats()?.totals?.completedOrders || 0 }}</h3>
                <p>Завершено заказов</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Engineers Table -->
      <mat-card class="engineers-table-card">
        <mat-card-header>
          <mat-card-title>Детализация по инженерам</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table
              mat-table
              [dataSource]="adminEngineerStats()?.engineers || []"
              class="engineers-table"
            >
              <!-- Engineer Name Column -->
              <ng-container matColumnDef="engineerName">
                <th mat-header-cell *matHeaderCellDef>Инженер</th>
                <td mat-cell *matCellDef="let element">
                  <div class="engineer-info">
                    <strong>{{ element.engineerName }}</strong>
                    <small>{{ element.email }}</small>
                  </div>
                </td>
                <td mat-footer-cell *matFooterCellDef><strong>ИТОГО:</strong></td>
              </ng-container>

              <!-- Completed Orders Column -->
              <ng-container matColumnDef="completedOrders">
                <th mat-header-cell *matHeaderCellDef>Заказов</th>
                <td mat-cell *matCellDef="let element">{{ element.completedOrders }}</td>
                <td mat-footer-cell *matFooterCellDef>
                  <strong>{{ adminEngineerStats()?.totals?.completedOrders }}</strong>
                </td>
              </ng-container>

              <!-- Total Hours Column -->
              <ng-container matColumnDef="totalHours">
                <th mat-header-cell *matHeaderCellDef>Часов</th>
                <td mat-cell *matCellDef="let element">{{ element.totalHours.toFixed(1) }}</td>
                <td mat-footer-cell *matFooterCellDef>
                  <strong>{{ (adminEngineerStats()?.totals?.totalHours || 0).toFixed(1) }}</strong>
                </td>
              </ng-container>

              <!-- Organization Payments Column -->
              <ng-container matColumnDef="organizationPayments">
                <th mat-header-cell *matHeaderCellDef>От организаций</th>
                <td mat-cell *matCellDef="let element">
                  {{ formatAmount(element.organizationPayments) }}
                </td>
                <td mat-footer-cell *matFooterCellDef>
                  <strong>{{
                    formatAmount(adminEngineerStats()?.totals?.organizationPayments || 0)
                  }}</strong>
                </td>
              </ng-container>

              <!-- Engineer Earnings Column -->
              <ng-container matColumnDef="engineerEarnings">
                <th mat-header-cell *matHeaderCellDef>Инженеру</th>
                <td mat-cell *matCellDef="let element">
                  {{ formatAmount(element.engineerEarnings) }}
                </td>
                <td mat-footer-cell *matFooterCellDef>
                  <strong>{{
                    formatAmount(adminEngineerStats()?.totals?.engineerEarnings || 0)
                  }}</strong>
                </td>
              </ng-container>

              <!-- Profit Column -->
              <ng-container matColumnDef="profit">
                <th mat-header-cell *matHeaderCellDef>Прибыль</th>
                <td
                  mat-cell
                  *matCellDef="let element"
                  [class.positive-profit]="element.profit > 0"
                  [class.negative-profit]="element.profit < 0"
                >
                  {{ formatAmount(element.profit) }}
                </td>
                <td
                  mat-footer-cell
                  *matFooterCellDef
                  [class.positive-profit]="(adminEngineerStats()?.totals?.profit || 0) > 0"
                >
                  <strong>{{ formatAmount(adminEngineerStats()?.totals?.profit || 0) }}</strong>
                </td>
              </ng-container>

              <!-- Profit Margin Column -->
              <ng-container matColumnDef="profitMargin">
                <th mat-header-cell *matHeaderCellDef>Маржа</th>
                <td
                  mat-cell
                  *matCellDef="let element"
                  [class.positive-profit]="element.profitMargin > 0"
                  [class.negative-profit]="element.profitMargin < 0"
                >
                  {{ element.profitMargin.toFixed(1) }}%
                </td>
                <td
                  mat-footer-cell
                  *matFooterCellDef
                  [class.positive-profit]="(adminEngineerStats()?.totals?.profitMargin || 0) > 0"
                >
                  <strong
                    >{{ (adminEngineerStats()?.totals?.profitMargin || 0).toFixed(1) }}%</strong
                  >
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="[
                  'engineerName',
                  'completedOrders',
                  'totalHours',
                  'organizationPayments',
                  'engineerEarnings',
                  'profit',
                  'profitMargin',
                ]"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  columns: [
                    'engineerName',
                    'completedOrders',
                    'totalHours',
                    'organizationPayments',
                    'engineerEarnings',
                    'profit',
                    'profitMargin',
                  ]
                "
              ></tr>
              <tr
                mat-footer-row
                *matFooterRowDef="[
                  'engineerName',
                  'completedOrders',
                  'totalHours',
                  'organizationPayments',
                  'engineerEarnings',
                  'profit',
                  'profitMargin',
                ]"
              ></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </section>

    <!-- Quick Actions -->
    <section class="actions-section">
      <h2>Быстрые действия</h2>
      <div class="actions-grid">
        <mat-card class="action-card" routerLink="/orders">
          <mat-card-content>
            <div class="action-content">
              <mat-icon>shopping_cart</mat-icon>
              <div>
                <h4>Просмотр заказов</h4>
                <p>Управление и отслеживание всех заказов</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card *ngIf="showUserStats()" class="action-card" routerLink="/users">
          <mat-card-content>
            <div class="action-content">
              <mat-icon>people</mat-icon>
              <div>
                <h4>Управление пользователями</h4>
                <p>Просмотр и управление учетными записями пользователей</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="action-card" routerLink="/orders">
          <mat-card-content>
            <div class="action-content">
              <mat-icon>inventory</mat-icon>
              <div>
                <h4 i18n="@@dashboard.inventory">Inventory</h4>
                <p i18n="@@dashboard.manageInventory">Manage inventory and orders</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="action-card" routerLink="/reports">
          <mat-card-content>
            <div class="action-content">
              <mat-icon>analytics</mat-icon>
              <div>
                <h4>Отчеты</h4>
                <p>Просмотр подробных отчетов</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </section>
  </div>
</div>
