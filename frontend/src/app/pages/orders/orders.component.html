<div class="orders-container">
  <!-- Earnings Summary Component -->
  <app-earnings-summary [collapsible]="true"></app-earnings-summary>

  <!-- Unaccepted Orders Warning -->
  <mat-card class="warning-card" *ngIf="hasUnacceptedOrders()">
    <mat-card-content>
      <div class="warning-content">
        <mat-icon class="warning-icon">warning</mat-icon>
        <div class="warning-text">
          <strong>Внимание!</strong>
          <span *ngIf="canViewAllOrders">
            У вас {{ getUnacceptedOrdersCount() }} непринятых заявок, ожидающих подтверждения.
          </span>
          <span *ngIf="!canViewAllOrders">
            У вас есть непринятые заявки, ожидающие подтверждения.
          </span>
        </div>
        <button mat-raised-button color="warn" (click)="onStatusFilterChange('assigned')">
          Посмотреть
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Order Statistics Section (Collapsible) -->
  <mat-card class="order-stats-card">
    <mat-card-header (click)="toggleOrderStats()" class="clickable-header">
      <div class="stats-header-content">
        <div class="stats-title">
          <mat-icon>bar_chart</mat-icon>
          <span>Статистика по заказам</span>
        </div>
        <button mat-icon-button class="expand-btn">
          <mat-icon>{{ orderStatsCollapsed() ? 'expand_more' : 'expand_less' }}</mat-icon>
        </button>
      </div>
    </mat-card-header>

    <mat-card-content *ngIf="!orderStatsCollapsed()">
      <!-- Переключатель вариантов статистики -->
      <div class="stats-switcher">
    <mat-button-toggle-group [(ngModel)]="statsView" aria-label="Вариант отображения статистики" class="stats-toggle-group">
      <mat-button-toggle value="compact" class="stats-toggle-btn">
        <mat-icon>view_module</mat-icon>
        <span class="toggle-text">Компактная</span>
      </mat-button-toggle>
      <mat-button-toggle value="charts" class="stats-toggle-btn">
        <mat-icon>bar_chart</mat-icon>
        <span class="toggle-text">С графиками</span>
      </mat-button-toggle>
      <mat-button-toggle value="progress" class="stats-toggle-btn">
        <mat-icon>trending_up</mat-icon>
        <span class="toggle-text">С прогрессом</span>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- ВАРИАНТ 1: Компактная таблица -->
  <mat-card class="stats-card-unified" *ngIf="statsView === 'compact'">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>bar_chart</mat-icon>
        Статистика заказов
      </mat-card-title>
      <div class="export-btn-container" *ngIf="canExportOrders">
        <button 
          mat-icon-button 
          color="accent" 
          (click)="exportStatisticsToExcel()"
          matTooltip="Скачать статистику">
          <mat-icon>file_download</mat-icon>
        </button>
      </div>
    </mat-card-header>
    
    <mat-card-content>
      <div class="stats-table">
        <!-- Статусы заказов -->
        <div class="stats-section">
          <h3>По статусам</h3>
          <div class="stats-row">
            <div class="stat-item">
              <mat-icon color="primary">assignment</mat-icon>
              <span class="label">Всего:</span>
              <span class="value">{{ orderStats().total }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>schedule</mat-icon>
              <span class="label">Ожидают:</span>
              <span class="value">{{ orderStats().waiting }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>person_add</mat-icon>
              <span class="label">В обработке:</span>
              <span class="value">{{ orderStats().processing }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>build</mat-icon>
              <span class="label">В работе:</span>
              <span class="value">{{ orderStats().working }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>visibility</mat-icon>
              <span class="label">На проверке:</span>
              <span class="value">{{ orderStats().review }}</span>
            </div>
            <div class="stat-item">
              <mat-icon style="color: #4caf50">check_circle</mat-icon>
              <span class="label">Завершено:</span>
              <span class="value">{{ orderStats().completed }}</span>
            </div>
          </div>
        </div>

        <!-- mat-divider></mat-divider -->

        <!-- Источники заказов - СКРЫТО -->
        <!-- div class="stats-section">
          <h3>По источникам</h3>
          <div class="stats-row">
            <div class="stat-item">
              <mat-icon>touch_app</mat-icon>
              <span class="label">Вручную:</span>
              <span class="value">{{ orderStats().bySource.manual }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>settings</mat-icon>
              <span class="label">Автоматически:</span>
              <span class="value">{{ orderStats().bySource.automatic }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>email</mat-icon>
              <span class="label">Из Email:</span>
              <span class="value">{{ orderStats().bySource.email }}</span>
            </div>
            <div class="stat-item">
              <mat-icon>api</mat-icon>
              <span class="label">Через API:</span>
              <span class="value">{{ orderStats().bySource.api }}</span>
            </div>
          </div>
        </div -->
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ВАРИАНТ 2: С графиками -->
  <mat-card class="stats-card-charts" *ngIf="statsView === 'charts'">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>bar_chart</mat-icon>
        Статистика заказов
      </mat-card-title>
      <div class="export-btn-container" *ngIf="canExportOrders">
        <button 
          mat-icon-button 
          color="accent" 
          (click)="exportStatisticsToExcel()"
          matTooltip="Скачать статистику">
          <mat-icon>file_download</mat-icon>
        </button>
      </div>
    </mat-card-header>
    
    <mat-card-content>
      <div class="charts-container">
        <!-- График по статусам (Donut Chart) -->
        <div class="chart-section">
          <h3>Распределение по статусам</h3>
          <div class="chart-wrapper">
            <canvas
              baseChart
              [data]="statusChartData"
              [options]="doughnutChartOptions"
              [type]="'doughnut'"
            ></canvas>
          </div>
          <div class="chart-stats">
            <div class="stat-badge" *ngFor="let stat of statusStats">
              <span class="badge-color" [style.background-color]="stat.color"></span>
              <span class="badge-label">{{ stat.label }}:</span>
              <span class="badge-value">{{ stat.value }}</span>
            </div>
          </div>
        </div>

        <!-- График по источникам (Bar Chart) - СКРЫТО -->
        <!-- div class="chart-section">
          <h3>Источники заказов</h3>
          <div class="chart-wrapper">
            <canvas
              baseChart
              [data]="sourceChartData"
              [options]="barChartOptions"
              [type]="'bar'"
            ></canvas>
          </div>
        </div -->
      </div>

      <!-- Итоговая статистика -->
      <div class="total-stats">
        <div class="total-item">
          <mat-icon color="primary">assignment</mat-icon>
          <div>
            <div class="total-label">Всего заказов</div>
            <div class="total-value">{{ orderStats().total }}</div>
          </div>
        </div>
        <div class="total-item">
          <mat-icon color="accent">build</mat-icon>
          <div>
            <div class="total-label">В работе</div>
            <div class="total-value">{{ orderStats().working }}</div>
          </div>
        </div>
        <div class="total-item">
          <mat-icon style="color: #4caf50">check_circle</mat-icon>
          <div>
            <div class="total-label">Завершено</div>
            <div class="total-value">{{ orderStats().completed }}</div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ВАРИАНТ 3: С прогресс-барами -->
  <mat-card class="stats-card-progress" *ngIf="statsView === 'progress'">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>bar_chart</mat-icon>
        Статистика заказов
      </mat-card-title>
      <div class="export-btn-container" *ngIf="canExportOrders">
        <button 
          mat-icon-button 
          color="accent" 
          (click)="exportStatisticsToExcel()"
          matTooltip="Скачать статистику">
          <mat-icon>file_download</mat-icon>
        </button>
      </div>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Общий счётчик -->
      <div class="total-counter">
        <mat-icon>assignment</mat-icon>
        <div class="counter-text">
          <span class="counter-value">{{ orderStats().total }}</span>
          <span class="counter-label">Всего заказов</span>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Прогресс-бары по статусам -->
      <div class="progress-stats">
        <div class="progress-item">
          <div class="progress-header">
            <div class="progress-label-group">
              <mat-icon>schedule</mat-icon>
              <span class="progress-label">Ожидают</span>
            </div>
            <span class="progress-value">{{ orderStats().waiting }}</span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getProgressPercentage(orderStats().waiting)"
            color="warn"
          ></mat-progress-bar>
        </div>

        <div class="progress-item">
          <div class="progress-header">
            <div class="progress-label-group">
              <mat-icon>person_add</mat-icon>
              <span class="progress-label">В обработке</span>
            </div>
            <span class="progress-value">{{ orderStats().processing }}</span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getProgressPercentage(orderStats().processing)"
          ></mat-progress-bar>
        </div>

        <div class="progress-item">
          <div class="progress-header">
            <div class="progress-label-group">
              <mat-icon>build</mat-icon>
              <span class="progress-label">В работе</span>
            </div>
            <span class="progress-value">{{ orderStats().working }}</span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getProgressPercentage(orderStats().working)"
            color="accent"
          ></mat-progress-bar>
        </div>

        <div class="progress-item">
          <div class="progress-header">
            <div class="progress-label-group">
              <mat-icon>visibility</mat-icon>
              <span class="progress-label">На проверке</span>
            </div>
            <span class="progress-value">{{ orderStats().review }}</span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getProgressPercentage(orderStats().review)"
            color="warn"
          ></mat-progress-bar>
        </div>

        <div class="progress-item">
          <div class="progress-header">
            <div class="progress-label-group">
              <mat-icon style="color: #4caf50">check_circle</mat-icon>
              <span class="progress-label">Завершено</span>
            </div>
            <span class="progress-value">{{ orderStats().completed }}</span>
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="getProgressPercentage(orderStats().completed)"
            color="primary"
          ></mat-progress-bar>
        </div>
      </div>

      <!-- mat-divider></mat-divider -->

      <!-- Источники компактно - СКРЫТО -->
      <!-- div class="sources-compact">
        <h4>По источникам</h4>
        <div class="sources-row">
          <div class="source-chip">
            <mat-icon>touch_app</mat-icon>
            <span>Вручную: {{ orderStats().bySource.manual }}</span>
          </div>
          <div class="source-chip">
            <mat-icon>settings</mat-icon>
            <span>Авто: {{ orderStats().bySource.automatic }}</span>
          </div>
          <div class="source-chip">
            <mat-icon>email</mat-icon>
            <span>Email: {{ orderStats().bySource.email }}</span>
          </div>
          <div class="source-chip">
            <mat-icon>api</mat-icon>
            <span>API: {{ orderStats().bySource.api }}</span>
          </div>
        </div>
      </div -->
    </mat-card-content>
  </mat-card>

  <!-- Компактная мобильная статистика -->
  <mat-card class="mobile-summary-card" *ngIf="isMobileView()">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>dashboard</mat-icon>
        Обзор заказов
      </mat-card-title>
      <div class="mobile-export-btn" *ngIf="canExportOrders">
        <button 
          mat-icon-button 
          color="primary" 
          (click)="exportStatisticsToExcel()"
          matTooltip="Скачать статистику"
          class="export-btn-mobile">
          <mat-icon>file_download</mat-icon>
        </button>
      </div>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Основные метрики -->
      <div class="mobile-summary-grid">
        <div class="summary-item primary">
          <div class="summary-icon">
            <mat-icon>assignment</mat-icon>
          </div>
          <div class="summary-content">
            <div class="summary-value">{{ orderStats().total }}</div>
            <div class="summary-label">Всего заказов</div>
          </div>
        </div>

        <div class="summary-item success">
          <div class="summary-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="summary-content">
            <div class="summary-value">{{ orderStats().completed }}</div>
            <div class="summary-label">Завершено</div>
          </div>
        </div>

        <div class="summary-item warning">
          <div class="summary-icon">
            <mat-icon>build</mat-icon>
          </div>
          <div class="summary-content">
            <div class="summary-value">{{ orderStats().working }}</div>
            <div class="summary-label">В работе</div>
          </div>
        </div>

        <div class="summary-item info">
          <div class="summary-icon">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="summary-content">
            <div class="summary-value">{{ orderStats().waiting }}</div>
            <div class="summary-label">Ожидают</div>
          </div>
        </div>
      </div>

      <!-- Детальная статистика -->
      <div class="mobile-details">
        <div class="details-section">
          <h4>По статусам</h4>
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">В обработке:</span>
              <span class="detail-value">{{ orderStats().processing }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">На проверке:</span>
              <span class="detail-value">{{ orderStats().review }}</span>
            </div>
          </div>
        </div>

        <!-- div class="details-section">
          <h4>По источникам</h4>
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">Вручную:</span>
              <span class="detail-value">{{ orderStats().bySource.manual }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Автоматически:</span>
              <span class="detail-value">{{ orderStats().bySource.automatic }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email:</span>
              <span class="detail-value">{{ orderStats().bySource.email }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">API:</span>
              <span class="detail-value">{{ orderStats().bySource.api }}</span>
            </div>
          </div>
        </div -->
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Main Content -->
  <mat-card class="main-content">
    <mat-card-header>
      <div class="header">
        <h1 i18n="@@orders.management">Управление заказами</h1>
        <div class="header-actions">
          <mat-form-field class="filter-field">
            <mat-label>Фильтр по статусу</mat-label>
            <mat-select
              [value]="selectedStatus()"
              (selectionChange)="onStatusFilterChange($event.value)"
            >
              <mat-option value="">Все статусы</mat-option>
              <mat-option *ngFor="let status of statusOptions" [value]="status">
                {{ getStatusDisplay(status) }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field class="search-field">
            <mat-label>Поиск заказов</mat-label>
            <input
              matInput
              (keyup)="applyFilter($event)"
              placeholder="Поиск по названию, организации и т.д."
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <button
            mat-icon-button
            (click)="refreshData()"
            matTooltip="Обновить данные"
            aria-label="Обновить"
            class="header-btn refresh-btn"
          >
            <mat-icon>refresh</mat-icon>
          </button>

          <button
            mat-raised-button
            color="accent"
            (click)="exportToExcel()"
            matTooltip="Экспортировать данные в Excel"
            aria-label="Экспортировать в Excel"
            *ngIf="canExportOrders"
            class="header-btn export-btn"
          >
            <mat-icon>download</mat-icon>
            <span class="btn-text">Скачать XLS</span>
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="onCreateOrder()"
            *ngIf="canCreateOrders"
            class="header-btn create-btn"
          >
            <mat-icon>add</mat-icon>
            <span class="btn-text">Создать заказ</span>
          </button>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="loading-container" *ngIf="isLoading()">
        <mat-spinner diameter="40"></mat-spinner>
        <p i18n="@@orders.loading">Загрузка заказов...</p>
      </div>

      <div class="table-container" *ngIf="!isLoading()">
        <table mat-table [dataSource]="dataSource" matSort class="orders-table">
          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@orders.id">№</th>
            <td mat-cell *matCellDef="let order">{{ order.id }}</td>
          </ng-container>

          <!-- Title Column -->
          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@orders.title">
              Название
            </th>
            <td mat-cell *matCellDef="let order">
              <strong>{{ order.title }}</strong>
              <br />
              <small class="text-muted">{{ order.description }}</small>
            </td>
          </ng-container>

          <!-- Organization Column -->
          <ng-container matColumnDef="organization">
            <th mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@orders.organization">
              Организация
            </th>
            <td mat-cell *matCellDef="let order">{{ getOrganizationName(order) }}</td>
          </ng-container>

          <!-- Assigned Engineer Column -->
          <ng-container matColumnDef="assignedEngineer">
            <th mat-header-cell *matHeaderCellDef mat-sort-header i18n="@@orders.engineer">
              Инженер
            </th>
            <td mat-cell *matCellDef="let order">
              <div class="engineer-info">
                <div class="assigned-engineer" *ngIf="order.assignedEngineer">
                  <mat-icon class="engineer-icon">engineering</mat-icon>
                  <span class="engineer-name">{{ getEngineerName(order) }}</span>
                </div>
                <div class="no-engineer" *ngIf="!order.assignedEngineer">
                  <mat-icon class="no-engineer-icon">person_off</mat-icon>
                  <span class="no-engineer-text">Не назначен</span>
                </div>
                <div class="creator-info">
                  <mat-icon class="creator-icon">person_outline</mat-icon>
                  <small class="text-muted">{{ getCreatorName(order) }}</small>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Статус</th>
            <td mat-cell *matCellDef="let order">
              <mat-chip [color]="getStatusColor(order.status)" selected>
                {{ getStatusDisplay(order.status) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Created Date Column -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Создан</th>
            <td mat-cell *matCellDef="let order">{{ order.createdAt | date: 'short' }}</td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Действия</th>
            <td mat-cell *matCellDef="let order">
              <div class="actions-container">
                <!-- Engineer Actions Group -->
                <div class="action-group engineer-actions" *ngIf="canAcceptOrder(order) || canCompleteWork(order)">
                  <button
                    mat-raised-button
                    color="accent"
                    (click)="onAcceptOrder(order)"
                    matTooltip="Подтвердить заявку и начать работу"
                    *ngIf="canAcceptOrder(order)"
                    class="action-btn primary-action"
                  >
                    <mat-icon>check_circle</mat-icon>
                    <span class="btn-text">Подтвердить</span>
                  </button>

                  <button
                    mat-raised-button
                    color="primary"
                    (click)="onCompleteWork(order)"
                    matTooltip="Внести данные о выполненной работе"
                    *ngIf="canCompleteWork(order)"
                    class="action-btn primary-action"
                  >
                    <mat-icon>task_alt</mat-icon>
                    <span class="btn-text">Выполнить</span>
                  </button>
                </div>

                <!-- Admin/Manager Actions Group -->
                <div class="action-group admin-actions">
                  <!-- Edit Actions -->
                  <div class="edit-actions" *ngIf="canEditOrder(order) || canEditCompletedOrder(order)">
                    <button
                      mat-icon-button
                      (click)="onEditOrder(order)"
                      color="primary"
                      matTooltip="Редактировать заказ"
                      aria-label="Редактировать"
                      *ngIf="canEditOrder(order)"
                      class="action-btn-icon edit-btn"
                    >
                      <mat-icon>edit</mat-icon>
                    </button>

                    <button
                      mat-icon-button
                      (click)="onEditOrder(order)"
                      color="warn"
                      matTooltip="Редактировать завершенный заказ (доступно 24 часа)"
                      aria-label="Редактировать"
                      *ngIf="canEditCompletedOrder(order)"
                      class="action-btn-icon edit-completed-btn"
                    >
                      <mat-icon>edit_note</mat-icon>
                    </button>
                  </div>

                  <!-- Status Management -->
                  <div class="status-actions" *ngIf="canUpdateOrderStatus(order)">
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="statusMenu"
                      color="accent"
                      matTooltip="Изменить статус"
                      aria-label="Изменить статус"
                      class="action-btn-icon status-btn"
                    >
                      <mat-icon>swap_vert</mat-icon>
                    </button>
                    <mat-menu #statusMenu="matMenu" class="status-menu">
                      <button
                        mat-menu-item
                        *ngFor="let status of getAvailableStatuses(order)"
                        [disabled]="order.status === status"
                        (click)="onUpdateStatus(order, status)"
                        class="status-menu-item"
                      >
                        <mat-icon [color]="getStatusColor(status)">{{ getStatusIcon(status) }}</mat-icon>
                        <span>{{ getStatusDisplay(status) }}</span>
                      </button>
                    </mat-menu>
                  </div>

                  <!-- Assignment Actions -->
                  <div class="assignment-actions" *ngIf="canAssignEngineers">
                    <button
                      mat-icon-button
                      (click)="onAssignEngineer(order)"
                      [disabled]="order.status === 'completed'"
                      color="primary"
                      [matTooltip]="order.assignedEngineerId ? 'Переназначить инженера' : 'Назначить инженера'"
                      [attr.aria-label]="order.assignedEngineerId ? 'Переназначить инженера' : 'Назначить инженера'"
                      class="action-btn-icon assign-btn"
                    >
                      <mat-icon>{{ order.assignedEngineerId ? 'swap_horiz' : 'person_add' }}</mat-icon>
                    </button>
                  </div>

                  <!-- Danger Actions -->
                  <div class="danger-actions" *ngIf="canDeleteOrders">
                    <button
                      mat-icon-button
                      (click)="onDeleteOrder(order)"
                      color="warn"
                      matTooltip="Удалить заказ"
                      aria-label="Удалить"
                      class="action-btn-icon delete-btn"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <!-- No data message -->
        <div class="no-data" *ngIf="dataSource.data.length === 0">
          <mat-icon>assignment</mat-icon>
          <h3>Заказы не найдены</h3>
          <p>Нет заказов, соответствующих критериям поиска, или заказы еще не были созданы.</p>
        </div>
      </div>

      <mat-paginator
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons
        aria-label="Выберите страницу заказов"
      >
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
