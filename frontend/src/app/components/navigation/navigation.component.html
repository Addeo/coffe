<mat-toolbar color="primary" class="navbar">
  <div class="navbar-content">
    <!-- Mobile Menu Button -->
    <button
      mat-icon-button
      class="mobile-menu-button"
      *ngIf="isAuthenticated()"
      (click)="toggleMobileMenu()"
      aria-label="Toggle mobile menu"
    >
      <mat-icon>{{ isMobileMenuOpen() ? 'close' : 'menu' }}</mat-icon>
    </button>

    <!-- Logo/Brand -->
    <div class="brand">
      <mat-icon class="brand-icon">local_cafe</mat-icon>
      <span class="brand-text" i18n="@@navigation.brand">Coffee Admin</span>
    </div>

    <!-- Navigation Links -->
    <nav class="nav-links" *ngIf="isAuthenticated()">
      <a
        mat-button
        *ngFor="let item of navigationItems()"
        [routerLink]="item.route === '#' ? null : item.route"
        routerLinkActive="active"
        [routerLinkActiveOptions]="{ exact: false }"
        (click)="item.route === '#' ? onRoleSwitchClick(item) : null"
        [class.role-switch-button]="item.route === '#'"
      >
        <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
        <span [attr.i18n]="item.i18nKey">{{ item.label }}</span>
      </a>
    </nav>

    <!-- Desktop Logout Button -->
    <div class="desktop-logout" *ngIf="isAuthenticated()">
      <button mat-icon-button (click)="logout()" matTooltip="Logout" aria-label="Logout">
        <mat-icon>logout</mat-icon>
      </button>
    </div>

    <!-- Mobile Navigation Menu -->
    <div class="mobile-menu-overlay" *ngIf="isMobileMenuOpen()" (click)="closeMobileMenu()">
      <div class="mobile-menu-content" (click)="$event.stopPropagation()">
        <div class="mobile-menu-header">
          <div class="brand">
            <mat-icon class="brand-icon">local_cafe</mat-icon>
            <span class="brand-text mobile-brand-text" i18n="@@navigation.brand">Coffee Admin</span>
          </div>
          <button mat-icon-button (click)="closeMobileMenu()" aria-label="Close menu">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <nav class="mobile-nav-links">
          <!-- Navigation Items -->
          <a
            mat-button
            *ngFor="let item of navigationItems()"
            [routerLink]="item.route"
            routerLinkActive="active"
            [routerLinkActiveOptions]="{ exact: false }"
            (click)="closeMobileMenu()"
          >
            <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
            <span [attr.i18n]="item.i18nKey">{{ item.label }}</span>
            <span
              *ngIf="item.badge"
              class="mobile-badge"
              matBadge="{{ item.badge }}"
              matBadgeColor="warn"
            ></span>
          </a>

          <!-- User Info Section (as link style) - hidden in mobile -->
          <!-- <a mat-button class="user-info-link" (click)="closeMobileMenu()">
            <mat-icon class="nav-icon">person</mat-icon>
            <div class="user-info-content mobile-hidden">
              <span class="user-full-name">{{ userName() }}</span>
              <span class="user-role-text">
                <mat-icon class="role-icon-small">{{ getRoleIcon(activeRole()!) }}</mat-icon>
                {{ getRoleDisplayName(activeRole()!) }}
                @if (canSwitchRoles()) {
                  <mat-icon class="switch-icon-small">sync_alt</mat-icon>
                }
              </span>
              <span class="user-email-text">{{ currentUser()?.email }}</span>
            </div>
          </a> -->

          <!-- Role Switcher for Mobile -->
          @if (canSwitchRoles()) {
            <div class="role-switcher-header">
              <span i18n="@@navigation.switchRole">Переключить роль</span>
            </div>
            @for (role of availableRoles(); track role) {
              <a
                mat-button
                class="role-option-link"
                [class.active-role]="isRoleActive(role)"
                [class.disabled]="isRoleActive(role) || isLoadingRoleSwitch()"
                (click)="!isRoleActive(role) && !isLoadingRoleSwitch() && switchRole(role); closeMobileMenu()"
              >
                <mat-icon class="nav-icon">{{ getRoleIcon(role) }}</mat-icon>
                <span>{{ getRoleDisplayName(role) }}</span>
                @if (isRoleActive(role)) {
                  <mat-icon class="check-icon">check</mat-icon>
                }
              </a>
            }
          }

          <!-- Actions (Logout only - theme toggle removed in mobile) -->
          <a mat-button class="logout-link" (click)="logout(); closeMobileMenu()">
            <mat-icon class="nav-icon">logout</mat-icon>
            <span i18n="@@navigation.logout">Выход</span>
          </a>
        </nav>
      </div>
    </div>

    <!-- Right Section -->
    <div class="right-section" *ngIf="isAuthenticated()">
      <!-- Theme Toggle -->
      <!-- <button
        mat-icon-button
        (click)="toggleTheme()"
        [matTooltip]="getThemeTooltip()"
        class="theme-toggle-button"
        aria-label="Toggle theme"
      >
        <mat-icon>{{ themeIcon() }}</mat-icon>
      </button> -->

      <!-- Notifications -->
      <div class="notifications-menu">
        <button
          mat-icon-button
          (click)="onViewAllNotifications()"
          class="notifications-button"
          matTooltip="Перейти к уведомлениям"
          aria-label="Уведомления"
        >
          <mat-icon class="notifications-icon">notifications</mat-icon>
          <span
            class="notifications-badge"
            *ngIf="unreadCount() > 0"
            matBadge="{{ unreadCount() }}"
            matBadgeColor="warn"
          ></span>
        </button>

        <mat-menu #notificationsMenu="matMenu" class="notifications-dropdown" style="display: none">
          <div class="notifications-header" mat-menu-item disabled>
            <h4 i18n="@@navigation.notifications">Уведомления</h4>
            <button
              mat-button
              *ngIf="unreadCount() > 0"
              (click)="onMarkAllAsRead()"
              i18n="@@notifications.markAllAsRead"
            >
              Отметить все как прочитанные
            </button>
          </div>

          <mat-divider></mat-divider>

          <div *ngIf="recentNotifications().length === 0" mat-menu-item disabled>
            <mat-icon>notifications_none</mat-icon>
            <span i18n="@@notifications.noNewNotifications">Нет новых уведомлений</span>
          </div>

          <div
            *ngFor="let notification of recentNotifications()"
            mat-menu-item
            [class.unread]="notification.status === 'unread'"
            (click)="onNotificationClick(notification)"
          >
            <div class="notification-item">
              <mat-icon [style.color]="getPriorityColor(notification.priority)">
                {{ getPriorityIcon(notification.priority) }}
              </mat-icon>
              <div class="notification-content">
                <div class="notification-title">{{ notification.title }}</div>
                <div class="notification-message">{{ notification.message }}</div>
                <div class="notification-time">{{ notification.createdAt | date: 'short' }}</div>
              </div>
              <mat-icon *ngIf="notification.status === 'unread'" class="unread-indicator"
                >fiber_manual_record</mat-icon
              >
            </div>
          </div>

          <mat-divider *ngIf="recentNotifications().length > 0"></mat-divider>

          <button mat-menu-item (click)="onViewAllNotifications()">
            <mat-icon>visibility</mat-icon>
            <span i18n="@@notifications.viewAllNotifications">Показать все уведомления</span>
          </button>
        </mat-menu>
      </div>

      <!-- User Menu (Desktop only) -->
      <div class="user-menu desktop-only">
        <button mat-button [matMenuTriggerFor]="userMenu" class="user-button">
          <mat-icon class="user-icon">account_circle</mat-icon>
          <span class="user-name">{{ userName() }}</span>
          <mat-icon class="dropdown-icon">expand_more</mat-icon>
        </button>

        <mat-menu #userMenu="matMenu" class="user-dropdown">
          <!-- Current Role Display -->
          <div style="padding: 12px 16px; border-bottom: 1px solid rgba(0, 0, 0, 0.1)">
            <div style="font-size: 12px; color: rgba(0, 0, 0, 0.5); margin-bottom: 4px">
              Текущая роль
            </div>
            <div style="display: flex; align-items: center; gap: 8px">
              <mat-icon style="font-size: 18px">{{ getRoleIcon(activeRole()!) }}</mat-icon>
              <span style="font-weight: 500">{{ getRoleDisplayName(activeRole()!) }}</span>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Role Switcher for Desktop -->
          @if (canSwitchRoles()) {
            <div class="role-switcher-section">
              <div class="section-title">
                <span>Переключить роль</span>
              </div>
              @for (role of availableRoles(); track role) {
                <button
                  (click)="!isRoleActive(role) && !isLoadingRoleSwitch() && switchRole(role)"
                  [disabled]="isRoleActive(role) || isLoadingRoleSwitch()"
                  [class.active-role]="isRoleActive(role)"
                >
                  <mat-icon>{{ getRoleIcon(role) }}</mat-icon>
                  <span>{{ getRoleDisplayName(role) }}</span>
                  @if (isRoleActive(role)) {
                    <mat-icon class="check-icon">check</mat-icon>
                  }
                  @if (isLoadingRoleSwitch() && !isRoleActive(role)) {
                    <mat-icon class="loading-icon">sync</mat-icon>
                  }
                </button>
              }
            </div>
            <mat-divider></mat-divider>
          }

          <!-- Test with regular buttons -->
          <button
            (click)="navigateToProfile()"
            style="
              width: 100%;
              text-align: left;
              padding: 12px 16px;
              border: none;
              background: none;
              cursor: pointer;
            "
          >
            <mat-icon>person</mat-icon>
            <span>Мой профиль</span>
          </button>

          <button
            (click)="logout()"
            style="
              width: 100%;
              text-align: left;
              padding: 12px 16px;
              border: none;
              background: none;
              cursor: pointer;
            "
          >
            <mat-icon>logout</mat-icon>
            <span>Выход</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </div>
</mat-toolbar>
