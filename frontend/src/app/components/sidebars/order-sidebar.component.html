<div class="order-sidebar">
  <div class="sidebar-header">
    <h2>{{ data?.isEdit ? 'Редактировать заказ' : 'Создать новый заказ' }}</h2>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="sidebar-content">
    <form [formGroup]="orderForm" class="order-form">
      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Название заказа</mat-label>
        <input matInput formControlName="title" placeholder="Введите название заказа" />
        <mat-error *ngIf="orderForm.get('title')?.hasError('required')">
          Название обязательно
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Описание</mat-label>
        <textarea
          matInput
          formControlName="description"
          placeholder="Введите описание заказа"
          rows="3"
        ></textarea>
      </mat-form-field>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Организация</mat-label>
          <mat-select formControlName="organizationId">
            <mat-option *ngFor="let org of organizations()" [value]="org.id">
              {{ org.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="orderForm.get('organizationId')?.hasError('required')">
            Организация обязательна
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Местоположение</mat-label>
          <input matInput formControlName="location" placeholder="Введите местоположение" />
          <mat-error *ngIf="orderForm.get('location')?.hasError('required')">
            Местоположение обязательно
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Расстояние (км)</mat-label>
          <input
            matInput
            type="number"
            formControlName="distanceKm"
            placeholder="Расстояние в км"
            min="0"
            step="0.1"
          />
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Тип территории</mat-label>
          <mat-select formControlName="territoryType">
            <mat-option [value]="TerritoryType.URBAN">Городской</mat-option>
            <mat-option [value]="TerritoryType.SUBURBAN">Пригородный</mat-option>
            <mat-option [value]="TerritoryType.RURAL">Сельский</mat-option>
            <mat-option [value]="TerritoryType.HOME">Домашний (≤60 км)</mat-option>
            <mat-option [value]="TerritoryType.ZONE_1">Зона 1 (61-199 км)</mat-option>
            <mat-option [value]="TerritoryType.ZONE_2">Зона 2 (200-250 км)</mat-option>
            <mat-option [value]="TerritoryType.ZONE_3">Зона 3 (>250 км)</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Планируемая дата начала</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="plannedStartDate" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <div class="form-row" *ngIf="data?.isEdit">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Статус заказа</mat-label>
          <mat-select formControlName="status">
            <mat-option [value]="OrderStatus.WAITING">Ожидает</mat-option>
            <mat-option [value]="OrderStatus.PROCESSING">В обработке</mat-option>
            <mat-option [value]="OrderStatus.WORKING">В работе</mat-option>
            <mat-option [value]="OrderStatus.REVIEW">На проверке</mat-option>
            <mat-option [value]="OrderStatus.COMPLETED">Завершен</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Источник</mat-label>
          <mat-select formControlName="source">
            <mat-option [value]="OrderSource.MANUAL">Вручную</mat-option>
            <mat-option [value]="OrderSource.AUTOMATIC">Автоматически</mat-option>
            <mat-option [value]="OrderSource.EMAIL">Email</mat-option>
            <mat-option [value]="OrderSource.API">API</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row" *ngIf="data?.isEdit">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Фактическая дата начала</mat-label>
          <input matInput [matDatepicker]="actualPicker" formControlName="actualStartDate" />
          <mat-datepicker-toggle matSuffix [for]="actualPicker"></mat-datepicker-toggle>
          <mat-datepicker #actualPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Дата завершения</mat-label>
          <input matInput [matDatepicker]="completionPicker" formControlName="completionDate" />
          <mat-datepicker-toggle matSuffix [for]="completionPicker"></mat-datepicker-toggle>
          <mat-datepicker #completionPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Files Section -->
      <div class="files-section">
        <h3>Файлы</h3>

        <!-- File Input -->
        <div class="file-input-container">
          <input
            type="file"
            #fileInput
            (change)="onFileSelected($event)"
            multiple
            accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls"
            style="display: none"
          />
          <button
            mat-stroked-button
            type="button"
            (click)="fileInput.click()"
            [disabled]="isUploadingInProgress()"
          >
            <mat-icon>add</mat-icon>
            Выбрать файлы
          </button>
        </div>

        <!-- Drag and Drop Area -->
        <div
          class="drop-zone"
          [class.drag-over]="isDragOver()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
        >
          <mat-icon>cloud_upload</mat-icon>
          <p>Перетащите файлы сюда или <button mat-button type="button" (click)="fileInput.click()">выберите</button></p>
          <small>Поддерживаемые форматы: изображения, PDF, документы (макс. 10MB)</small>
        </div>

        <!-- Upload Progress -->
        <div class="upload-progress" *ngIf="uploadProgress().length > 0">
          <h4>Загрузка файлов:</h4>
          <div class="progress-list">
            <div class="progress-item" *ngFor="let progress of uploadProgress()">
              <div class="progress-header">
                <span class="file-name">{{ progress.file.name }}</span>
                <span class="progress-status" [class]="progress.status">
                  {{ progress.status === 'uploading' ? progress.progress + '%' :
                     progress.status === 'completed' ? 'Готово' :
                     progress.status === 'error' ? 'Ошибка' : 'Ожидание' }}
                </span>
              </div>
              <mat-progress-bar
                mode="determinate"
                [value]="progress.progress"
                [class]="progress.status"
              ></mat-progress-bar>
              <div class="error-message" *ngIf="progress.error">
                {{ progress.error }}
              </div>
            </div>
          </div>
        </div>

        <!-- Successfully Uploaded Files Ready for Attachment -->
        <div class="uploaded-files" *ngIf="getCompletedUploads().length > 0">
          <h4>Загруженные файлы (будут прикреплены к заказу):</h4>
          <div class="file-list">
            <div class="file-item" *ngFor="let progress of getCompletedUploads(); let i = index">
              <span class="file-name">{{ progress.file.name }}</span>
              <span class="file-size">({{ (progress.file.size / 1024 / 1024).toFixed(2) }} MB)</span>
              <button mat-icon-button (click)="removeUploadedFile(getUploadIndex(progress))" type="button">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Attached Files (for edit mode) -->
        <div class="attached-files" *ngIf="attachedFiles().length > 0">
          <h4>Прикрепленные файлы:</h4>
          <div class="file-list">
            <div class="file-item" *ngFor="let file of attachedFiles()">
              <span class="file-name">{{ file.originalName }}</span>
              <span class="file-size">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
              <button mat-icon-button (click)="viewFile(file)" type="button">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button (click)="removeAttachedFile(file.id)" type="button">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="sidebar-actions">
    <button mat-button (click)="onCancel()">Отмена</button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSave()"
      [disabled]="orderForm.invalid || isLoading() || isUploadingInProgress()"
    >
      <mat-spinner diameter="20" *ngIf="isLoading()"></mat-spinner>
      <span *ngIf="!isLoading()">{{ data?.isEdit ? 'Обновить' : 'Создать' }}</span>
    </button>
  </div>
</div>
