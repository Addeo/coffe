# Диаграмма потока расчётов статистики

## 🔄 Поток данных: От заказа до статистики

```
┌─────────────────────────────────────────────────────────────────┐
│  FRONTEND: Инженер заполняет данные о выполненной работе        │
│  ────────────────────────────────────────────────────────────   │
│  ✏️ regularHours: 8 ч                                           │
│  ✏️ overtimeHours: 2 ч                                          │
│  ✏️ carUsageAmount: 500 ₽                                       │
│  ✏️ workNotes: "Работа выполнена"                              │
│  ✏️ status: "completed"                                         │
└─────────────────────────────────────────────────────────────────┘
                            ⬇️
                  PATCH /api/orders/123
                            ⬇️
┌─────────────────────────────────────────────────────────────────┐
│  BACKEND: OrdersService.update()                                │
│  ────────────────────────────────────────────────────────────   │
│  1️⃣ Загрузка данных:                                            │
│     • Инженер (assignedEngineerId = 1)                         │
│     • Организация (organizationId = 1)                         │
│     • Индивидуальные ставки (если есть)                        │
│                                                                 │
│  2️⃣ Получение ставок:                                           │
│     engineerBaseRate = 750 ₽/ч (индивидуальная)                │
│     engineerOvertimeRate = 1,125 ₽/ч                           │
│     organizationBaseRate = 900 ₽/ч                             │
│     organizationOvertimeMultiplier = 1.5                       │
│                                                                 │
│  3️⃣ Расчёт оплаты инженеру:                                     │
│     regularPayment = 8 × 750 = 6,000 ₽                         │
│     overtimePayment = 2 × 1,125 = 2,250 ₽                      │
│     calculatedAmount = 6,000 + 2,250 = 8,250 ₽                 │
│                                                                 │
│  4️⃣ Расчёт оплаты от организации:                               │
│     organizationRegularPayment = 8 × 900 = 7,200 ₽             │
│     organizationOvertimePayment = 2 × 900 × 1.5 = 2,700 ₽      │
│     organizationPayment = 7,200 + 2,700 = 9,900 ₽              │
│                                                                 │
│  5️⃣ Расчёт прибыли:                                              │
│     profit = 9,900 - 8,250 = 1,650 ₽                           │
│                                                                 │
│  6️⃣ Сохранение в Order:                                          │
│     UPDATE orders SET ... WHERE id = 123                       │
└─────────────────────────────────────────────────────────────────┘
                            ⬇️
                    ✅ Order сохранён
                            ⬇️
┌─────────────────────────────────────────────────────────────────┐
│  DATABASE: Таблица orders                                       │
│  ────────────────────────────────────────────────────────────   │
│  id: 123                                                        │
│  organizationId: 1                                              │
│  assignedEngineerId: 1                                          │
│  status: "completed" ✅                                          │
│  completionDate: "2025-10-05"                                   │
│  regularHours: 8                                                │
│  overtimeHours: 2                                               │
│  engineerBaseRate: 750                                          │
│  engineerOvertimeRate: 1125                                     │
│  organizationBaseRate: 900                                      │
│  organizationOvertimeMultiplier: 1.5                            │
│  regularPayment: 6000                                           │
│  overtimePayment: 2250                                          │
│  calculatedAmount: 8250                                         │
│  organizationRegularPayment: 7200                               │
│  organizationOvertimePayment: 2700                              │
│  organizationPayment: 9900                                      │
│  carUsageAmount: 500                                            │
│  profit: 1650                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 Расчёт статистики для инженера

```
┌─────────────────────────────────────────────────────────────────┐
│  FRONTEND: GET /api/statistics/earnings/comparison              │
│  userId = 4 (Иванов И.И.)                                       │
└─────────────────────────────────────────────────────────────────┘
                            ⬇️
┌─────────────────────────────────────────────────────────────────┐
│  BACKEND: StatisticsService.getEarningsComparison()             │
│  ────────────────────────────────────────────────────────────   │
│  1️⃣ Получение инженера:                                         │
│     engineer = Engineer.findOne({ userId: 4 })                 │
│     engineerId = engineer.id = 1                               │
│                                                                 │
│  2️⃣ SQL-запрос за октябрь 2025:                                 │
│     SELECT * FROM orders                                       │
│     WHERE assignedEngineerId = 1                               │
│       AND status = 'completed'                                 │
│       AND completionDate >= '2025-10-01'                       │
│       AND completionDate < '2025-11-01'                        │
│                                                                 │
│  3️⃣ Результат запроса:                                          │
│     [Order #1, Order #4]  // 2 заказа                          │
│                                                                 │
│  4️⃣ Агрегация данных:                                           │
│     currentTotalEarnings = 0                                   │
│     currentTotalHours = 0                                      │
│                                                                 │
│     for (const order of [Order #1, Order #4]):                │
│       ┌─────────────────────────────────────┐                 │
│       │ Order #1:                           │                 │
│       │   calculatedAmount = 8,250         │                 │
│       │   carUsageAmount = 500             │                 │
│       │   regularHours = 8                 │                 │
│       │   overtimeHours = 2                │                 │
│       │   ─────────────────────────────────│                 │
│       │   earnings = 8,250 + 500 = 8,750  │                 │
│       │   hours = 8 + 2 = 10               │                 │
│       └─────────────────────────────────────┘                 │
│       currentTotalEarnings += 8,750                           │
│       currentTotalHours += 10                                 │
│                                                                 │
│       ┌─────────────────────────────────────┐                 │
│       │ Order #4:                           │                 │
│       │   calculatedAmount = 9,750         │                 │
│       │   carUsageAmount = 450             │                 │
│       │   regularHours = 7                 │                 │
│       │   overtimeHours = 4                │                 │
│       │   ─────────────────────────────────│                 │
│       │   earnings = 9,750 + 450 = 10,200 │                 │
│       │   hours = 7 + 4 = 11               │                 │
│       └─────────────────────────────────────┘                 │
│       currentTotalEarnings += 10,200                          │
│       currentTotalHours += 11                                 │
│                                                                 │
│  5️⃣ Итоговые значения:                                          │
│     totalEarnings = 8,750 + 10,200 = 18,950 ₽                  │
│     totalHours = 10 + 11 = 21 ч                                │
│     completedOrders = 2                                        │
└─────────────────────────────────────────────────────────────────┘
                            ⬇️
                  Возврат результата
                            ⬇️
┌─────────────────────────────────────────────────────────────────┐
│  FRONTEND: Отображение для инженера                             │
│  ────────────────────────────────────────────────────────────   │
│  📊 Моя статистика за октябрь 2025                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  💰 Общий заработок:       18,950 ₽                             │
│  📦 Завершено заказов:     2                                    │
│  ⏱️  Отработано часов:      21 ч                                │
│  📈 Средний заказ:          9,475 ₽                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 Расчёт статистики для администратора

```
┌─────────────────────────────────────────────────────────────────┐
│  FRONTEND: GET /api/statistics/admin/engineers?month=10&year=2025│
└─────────────────────────────────────────────────────────────────┘
                            ⬇️
┌─────────────────────────────────────────────────────────────────┐
│  BACKEND: StatisticsService.getAdminEngineerStatistics()        │
│  ────────────────────────────────────────────────────────────   │
│  1️⃣ SQL-запрос (агрегация по инженерам):                        │
│                                                                 │
│  SELECT                                                         │
│    engineer.userId,                                             │
│    user.firstName,                                              │
│    user.lastName,                                               │
│    COUNT(order.id) as completedOrders,                         │
│    SUM(order.regularHours + order.overtimeHours) as totalHours,│
│    SUM(order.calculatedAmount) as engineerEarnings,            │
│    SUM(order.organizationPayment) as organizationPayments,     │
│    SUM(order.carUsageAmount) as carUsageAmount                 │
│  FROM orders                                                    │
│  JOIN engineer ON order.assignedEngineerId = engineer.id       │
│  JOIN user ON engineer.userId = user.id                        │
│  WHERE order.completionDate >= '2025-10-01'                    │
│    AND order.completionDate < '2025-11-01'                     │
│    AND order.status = 'completed'                              │
│  GROUP BY engineer.userId                                      │
│                                                                 │
│  2️⃣ Результат запроса:                                          │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ Иванов И.И. (userId=4):                                    ││
│  │   completedOrders: 2                                       ││
│  │   totalHours: 21 (10 + 11)                                 ││
│  │   engineerEarnings: 18,000 (8,250 + 9,750)                 ││
│  │   organizationPayments: 21,600 (9,900 + 11,700)            ││
│  │   carUsageAmount: 950 (500 + 450)                          ││
│  └────────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────────┐│
│  │ Петров П.П. (userId=5):                                    ││
│  │   completedOrders: 1                                       ││
│  │   totalHours: 9                                            ││
│  │   engineerEarnings: 7,350                                  ││
│  │   organizationPayments: 8,400                              ││
│  │   carUsageAmount: 400                                      ││
│  └────────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────────┐│
│  │ Сидоров С.С. (userId=6):                                   ││
│  │   completedOrders: 2                                       ││
│  │   totalHours: 20                                           ││
│  │   engineerEarnings: 16,400 (8,000 + 8,400)                 ││
│  │   organizationPayments: 18,400 (10,000 + 8,400)            ││
│  │   carUsageAmount: 950 (600 + 350)                          ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                 │
│  3️⃣ Расчёт итогов для каждого инженера:                         │
│                                                                 │
│  Иванов И.И.:                                                   │
│    totalEngineerPayment = 18,000 + 950 = 18,950 ₽              │
│    totalOrgPayment = 21,600 + 950 = 22,550 ₽                   │
│    profit = 21,600 - 18,000 = 3,600 ₽                          │
│    profitMargin = (3,600 / 22,550) × 100 = 16.0%               │
│                                                                 │
│  Петров П.П.:                                                   │
│    totalEngineerPayment = 7,350 + 400 = 7,750 ₽                │
│    totalOrgPayment = 8,400 + 400 = 8,800 ₽                     │
│    profit = 8,400 - 7,350 = 1,050 ₽                            │
│    profitMargin = (1,050 / 8,800) × 100 = 11.9%                │
│                                                                 │
│  Сидоров С.С.:                                                  │
│    totalEngineerPayment = 16,400 + 950 = 17,350 ₽              │
│    totalOrgPayment = 18,400 + 950 = 19,350 ₽                   │
│    profit = 18,400 - 16,400 = 2,000 ₽                          │
│    profitMargin = (2,000 / 19,350) × 100 = 10.3%               │
│                                                                 │
│  4️⃣ Общие итоги:                                                │
│    totalOrders = 5                                             │
│    totalHours = 50                                             │
│    totalEngineerPayments = 44,050 ₽                            │
│    totalOrgPayments = 50,700 ₽                                 │
│    totalProfit = 6,650 ₽                                       │
│    avgProfitMargin = (6,650 / 50,700) × 100 = 13.1%            │
└─────────────────────────────────────────────────────────────────┘
                            ⬇️
                    JSON Response
                            ⬇️
┌─────────────────────────────────────────────────────────────────┐
│  FRONTEND: Отображение для администратора                       │
│  ────────────────────────────────────────────────────────────   │
│  📊 Статистика по инженерам за октябрь 2025                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📈 Общая сводка                                         │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 💰 Оплата от организаций:    50,700 ₽                   │   │
│  │ 💵 Выплачено инженерам:      44,050 ₽                   │   │
│  │ 📊 Прибыль:                   6,650 ₽ (13.1%)           │   │
│  │ 📦 Завершено заказов:         5                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  📋 Детализация по инженерам:                                   │
│  ┌────────┬────────┬───────┬──────────┬──────────┬────────┬───┐│
│  │Инженер │ Заказов│ Часов │ Инженеру │ От орг.  │Прибыль │ % ││
│  ├────────┼────────┼───────┼──────────┼──────────┼────────┼───┤│
│  │Иванов  │   2    │  21   │ 18,950₽  │ 22,550₽  │ 3,600₽│16%││
│  │Сидоров │   2    │  20   │ 17,350₽  │ 19,350₽  │ 2,000₽│10%││
│  │Петров  │   1    │   9   │  7,750₽  │  8,800₽  │ 1,050₽│12%││
│  ├────────┼────────┼───────┼──────────┼──────────┼────────┼───┤│
│  │ ИТОГО: │   5    │  50   │ 44,050₽  │ 50,700₽  │ 6,650₽│13%││
│  └────────┴────────┴───────┴──────────┴──────────┴────────┴───┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔍 Детальный разбор по каждому инженеру

### Иванов И.И. (2 заказа за октябрь)

```
┌──────────────────────────────────────────────────────────────┐
│  Заказ #1 (05.10.2025, ООО "Альфа")                          │
├──────────────────────────────────────────────────────────────┤
│  Работа:         8 ч (обычные) + 2 ч (переработка)          │
│  Ставки инженера: 750 ₽/ч + 1,125 ₽/ч                       │
│  Ставки орг:     900 ₽/ч × 1.5                              │
│  ──────────────────────────────────────────────────────────  │
│  Инженеру:       6,000 + 2,250 + 500 = 8,750 ₽              │
│  От орг:         7,200 + 2,700 + 500 = 10,400 ₽             │
│  Прибыль:        1,650 ₽                                     │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  Заказ #4 (20.10.2025, ООО "Альфа")                          │
├──────────────────────────────────────────────────────────────┤
│  Работа:         7 ч (обычные) + 4 ч (переработка)          │
│  Ставки инженера: 750 ₽/ч + 1,125 ₽/ч                       │
│  Ставки орг:     900 ₽/ч × 1.5                              │
│  ──────────────────────────────────────────────────────────  │
│  Инженеру:       5,250 + 4,500 + 450 = 10,200 ₽             │
│  От орг:         6,300 + 5,400 + 450 = 12,150 ₽             │
│  Прибыль:        1,950 ₽                                     │
└──────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ИТОГО ИВАНОВ И.И.:
  Заказов:         2
  Часов:           21 (15 обычных + 6 переработки)
  Заработал:       18,950 ₽
  Принёс компании: 22,550 ₽
  Прибыль:         3,600 ₽
  Маржа:           16.0%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Петров П.П. (1 заказ за октябрь)

```
┌──────────────────────────────────────────────────────────────┐
│  Заказ #2 (10.10.2025, ООО "Бета")                           │
├──────────────────────────────────────────────────────────────┤
│  Работа:         6 ч (обычные) + 3 ч (переработка)          │
│  Ставки инженера: 700 ₽/ч + 1,050 ₽/ч                       │
│  Ставки орг:     800 ₽/ч × 1.5                              │
│  ──────────────────────────────────────────────────────────  │
│  Инженеру:       4,200 + 3,150 + 400 = 7,750 ₽              │
│  От орг:         4,800 + 3,600 + 400 = 8,800 ₽              │
│  Прибыль:        1,050 ₽                                     │
└──────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ИТОГО ПЕТРОВ П.П.:
  Заказов:         1
  Часов:           9 (6 обычных + 3 переработки)
  Заработал:       7,750 ₽
  Принёс компании: 8,800 ₽
  Прибыль:         1,050 ₽
  Маржа:           11.9%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Сидоров С.С. (2 заказа за октябрь)

```
┌──────────────────────────────────────────────────────────────┐
│  Заказ #3 (15.10.2025, ООО "Гамма")                          │
├──────────────────────────────────────────────────────────────┤
│  Работа:         10 ч (обычные) + 0 ч (переработка)         │
│  Ставки инженера: 800 ₽/ч + 1,200 ₽/ч                       │
│  Ставки орг:     1,000 ₽/ч × 2.0                            │
│  ──────────────────────────────────────────────────────────  │
│  Инженеру:       8,000 + 0 + 600 = 8,600 ₽                  │
│  От орг:         10,000 + 0 + 600 = 10,600 ₽                │
│  Прибыль:        2,000 ₽                                     │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  Заказ #5 (25.10.2025, ООО "Бета")                           │
├──────────────────────────────────────────────────────────────┤
│  Работа:         9 ч (обычные) + 1 ч (переработка)          │
│  Ставки инженера: 800 ₽/ч + 1,200 ₽/ч                       │
│  Ставки орг:     800 ₽/ч × 1.5                              │
│  ──────────────────────────────────────────────────────────  │
│  Инженеру:       7,200 + 1,200 + 350 = 8,750 ₽              │
│  От орг:         7,200 + 1,200 + 350 = 8,750 ₽              │
│  Прибыль:        0 ₽ ⚠️ НУЛЕВАЯ ПРИБЫЛЬ!                     │
└──────────────────────────────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ИТОГО СИДОРОВ С.С.:
  Заказов:         2
  Часов:           20 (19 обычных + 1 переработка)
  Заработал:       17,350 ₽
  Принёс компании: 19,350 ₽
  Прибыль:         2,000 ₽
  Маржа:           10.3%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 📈 ИТОГОВАЯ СТАТИСТИКА ЗА ОКТЯБРЬ 2025

### Для администратора (дашборд):

```
┌─────────────────────────────────────────────────────────────┐
│  💰 ФИНАНСОВАЯ СВОДКА ЗА ОКТЯБРЬ 2025                        │
├─────────────────────────────────────────────────────────────┤
│  Оплата от организаций:        50,700 ₽                     │
│  Выплачено инженерам:          44,050 ₽                     │
│  Прибыль:                       6,650 ₽ (13.1%)             │
│  Завершено заказов:             5                           │
│  Отработано часов:              50 ч                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  👥 РЕЙТИНГ ИНЖЕНЕРОВ ПО ПРИБЫЛЬНОСТИ                        │
├─────────────────────────────────────────────────────────────┤
│  🥇 1. Иванов И.И.    3,600 ₽ прибыли (16.0% маржа)         │
│  🥈 2. Сидоров С.С.   2,000 ₽ прибыли (10.3% маржа)         │
│  🥉 3. Петров П.П.    1,050 ₽ прибыли (11.9% маржа)         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  🏢 АНАЛИЗ ПО ОРГАНИЗАЦИЯМ                                   │
├─────────────────────────────────────────────────────────────┤
│  ООО "Альфа":   2 заказа,  22,550 ₽,  прибыль 3,600 ₽      │
│  ООО "Гамма":   1 заказ,   10,600 ₽,  прибыль 2,000 ₽      │
│  ООО "Бета":    2 заказа,  17,550 ₽,  прибыль 1,050 ₽      │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 ВЫВОДЫ И РЕКОМЕНДАЦИИ

### Анализ прибыльности:

#### ✅ Самый прибыльный инженер: Иванов И.И.

**Причины:**

- Индивидуальные повышенные ставки (750 ₽/ч vs 700 ₽/ч)
- Работает с организацией с хорошими ставками (900 ₽/ч)
- Большой объём переработки (6 часов)
- **Рекомендация:** Давать Иванову больше заказов от ООО "Альфа"

#### ⚠️ Проблемный заказ: #5 (Сидоров у ООО "Бета")

**Причины нулевой прибыли:**

- Базовая ставка инженера = Базовая ставка организации (800 ₽/ч)
- Ставка переработки инженера (1,200 ₽/ч) > Ставка орг с коэф. (800×1.5=1,200 ₽/ч)
- **Рекомендация:**
  1. Установить индивидуальную ставку для Сидорова у ООО "Бета" (например, 750 ₽/ч)
  2. Или повысить базовую ставку организации

#### 📊 Средняя маржа: 13.1%

**Оценка:** Нормальная прибыльность
**Рекомендации:**

- Оптимизировать ставки для инженеров с низкой маржой
- Установить индивидуальные ставки для часто работающих пар "инженер-организация"

---

## 🛠️ ТЕХНИЧЕСКИЕ ДЕТАЛИ

### Формула расчёта в коде:

```typescript
// Для каждого заказа:
const engineerTotal = order.calculatedAmount + order.carUsageAmount;
const organizationTotal = order.organizationPayment + order.carUsageAmount;
const profit = order.organizationPayment - order.calculatedAmount;

// Агрегация по инженеру:
const totalEngineerEarnings = SUM(calculatedAmount + carUsageAmount);
const totalOrganizationPayments = SUM(organizationPayment + carUsageAmount);
const totalProfit = SUM(profit);
const profitMargin = (totalProfit / totalOrganizationPayments) × 100;
```

### Важно:

- ✅ Статистика считается **в реальном времени** при каждом запросе
- ✅ Данные **всегда актуальные** (нет кэша)
- ✅ Один источник истины: **таблица orders**
- ✅ Детальная разбивка доступна для каждого заказа
