# Визуальный пример расчёта статистики

## 📊 Три инженера, пять заказов, октябрь 2025

```
        ИВАНОВ И.И.           ПЕТРОВ П.П.          СИДОРОВ С.С.
           (2 заказа)            (1 заказ)            (2 заказа)
              │                     │                     │
              │                     │                     │
    ┌─────────┴─────────┐          │          ┌──────────┴──────────┐
    │                   │          │          │                     │
    ▼                   ▼          ▼          ▼                     ▼
┌────────┐        ┌────────┐  ┌────────┐  ┌────────┐        ┌────────┐
│Заказ #1│        │Заказ #4│  │Заказ #2│  │Заказ #3│        │Заказ #5│
├────────┤        ├────────┤  ├────────┤  ├────────┤        ├────────┤
│05.10.25│        │20.10.25│  │10.10.25│  │15.10.25│        │25.10.25│
│        │        │        │  │        │  │        │        │        │
│ООО Альфа        │ООО Альфа  │ООО Бета│  │ООО Гамма        │ООО Бета│
│        │        │        │  │        │  │        │        │        │
│8ч + 2ч │        │7ч + 4ч │  │6ч + 3ч │  │10ч + 0ч│        │9ч + 1ч │
│переработки      │переработки│переработки│без пер. │        │переработки
│        │        │        │  │        │  │        │        │        │
│8,750₽  │        │10,200₽ │  │7,750₽  │  │8,600₽  │        │8,750₽  │
│→инженеру        │→инженеру  │→инженеру  │→инженеру        │→инженеру
│        │        │        │  │        │  │        │        │        │
│10,400₽ │        │12,150₽ │  │8,800₽  │  │10,600₽ │        │8,750₽  │
│←от орг  │        │←от орг │  │←от орг │  │←от орг │        │←от орг │
│        │        │        │  │        │  │        │        │        │
│📈1,650₽│        │📈1,950₽│  │📈1,050₽│  │📈2,000₽│        │📈0₽    │
│прибыль │        │прибыль │  │прибыль │  │прибыль │        │прибыль │
└────────┘        └────────┘  └────────┘  └────────┘        └────────┘
```

---

## 💰 АГРЕГАЦИЯ ПО ИНЖЕНЕРАМ

```
┌─────────────────────────────────────────────────────────────────┐
│  ИВАНОВ И.И.                                                    │
├─────────────────────────────────────────────────────────────────┤
│  Заказ #1:  8,750₽  │  Заказ #4:  10,200₽                      │
│  ────────────────────┴────────────────────                      │
│  ИТОГО: 18,950₽                                                 │
│                                                                 │
│  ┌──────────────────────────────────────────┐                  │
│  │ Заработал:       18,950 ₽ ▓▓▓▓▓▓▓▓▓░░  │                  │
│  │ Принёс:          22,550 ₽ ▓▓▓▓▓▓▓▓▓▓▓  │                  │
│  │ Прибыль:          3,600 ₽ ▓▓░░░░░░░░░  │                  │
│  │ Маржа:              16.0% ▓▓▓▓▓▓▓▓░░░░  │                  │
│  └──────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  ПЕТРОВ П.П.                                                    │
├─────────────────────────────────────────────────────────────────┤
│  Заказ #2:  7,750₽                                              │
│  ────────────────────                                           │
│  ИТОГО: 7,750₽                                                  │
│                                                                 │
│  ┌──────────────────────────────────────────┐                  │
│  │ Заработал:        7,750 ₽ ▓▓▓▓░░░░░░░  │                  │
│  │ Принёс:           8,800 ₽ ▓▓▓▓▓░░░░░░░  │                  │
│  │ Прибыль:          1,050 ₽ ▓░░░░░░░░░░░  │                  │
│  │ Маржа:              11.9% ▓▓▓▓▓▓░░░░░░  │                  │
│  └──────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  СИДОРОВ С.С.                                                   │
├─────────────────────────────────────────────────────────────────┤
│  Заказ #3:  8,600₽  │  Заказ #5:  8,750₽                       │
│  ────────────────────┴────────────────────                      │
│  ИТОГО: 17,350₽                                                 │
│                                                                 │
│  ┌──────────────────────────────────────────┐                  │
│  │ Заработал:       17,350 ₽ ▓▓▓▓▓▓▓▓░░░  │                  │
│  │ Принёс:          19,350 ₽ ▓▓▓▓▓▓▓▓▓░░  │                  │
│  │ Прибыль:          2,000 ₽ ▓░░░░░░░░░░░  │                  │
│  │ Маржа:              10.3% ▓▓▓▓▓░░░░░░░  │                  │
│  └──────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 ОБЩАЯ КАРТИНА

```
                    ОКТЯБРЬ 2025
        ╔════════════════════════════════════╗
        ║   💼 ФИНАНСОВЫЕ ПОКАЗАТЕЛИ         ║
        ╚════════════════════════════════════╝

        ┌────────────────────────────────────┐
        │  От организаций:     50,700 ₽     │ ⬅️ Доход
        └────────────────────────────────────┘
                      │
                      │ 📊 Распределение
                      ├──────────────────────┐
                      ▼                      ▼
        ┌─────────────────────┐  ┌────────────────┐
        │ Инженерам: 44,050 ₽ │  │ Прибыль: 6,650₽│
        └─────────────────────┘  └────────────────┘
              (87%)                   (13%)

        ╔════════════════════════════════════╗
        ║   📊 РАЗБИВКА ПО ИНЖЕНЕРАМ         ║
        ╚════════════════════════════════════╝

        Иванов И.И.  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░ 43%  (18,950₽)
        Сидоров С.С. ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░ 39%  (17,350₽)
        Петров П.П.  ▓▓▓▓▓▓░░░░░░░░░░░░░░ 18%  (7,750₽)
                     └────────────────────┘
                         44,050₽ всего

        ╔════════════════════════════════════╗
        ║   💹 ПРИБЫЛЬНОСТЬ                  ║
        ╚════════════════════════════════════╝

        Иванов И.И.  ████████████████ 54%  (3,600₽ из 6,650₽)
        Сидоров С.С. █████████ 30%         (2,000₽)
        Петров П.П.  ████ 16%              (1,050₽)

        ╔════════════════════════════════════╗
        ║   ⏱️  НАГРУЗКА (часы)              ║
        ╚════════════════════════════════════╝

        Иванов И.И.  ████████████ 42%  (21ч из 50ч)
        Сидоров С.С. ███████████ 40%   (20ч)
        Петров П.П.  █████ 18%         (9ч)
```

---

## 🔍 SQL-ЗАПРОСЫ ДЛЯ ПРОВЕРКИ

### Проверка статистики Иванова:
```sql
SELECT 
  SUM(calculatedAmount + carUsageAmount) as earnings,
  SUM(regularHours + overtimeHours) as hours,
  COUNT(*) as orders
FROM orders
WHERE assignedEngineerId = 1
  AND status = 'completed'
  AND completionDate >= '2025-10-01'
  AND completionDate < '2025-11-01';

-- Ожидается: earnings=18950, hours=21, orders=2
```

### Проверка общей статистики:
```sql
SELECT 
  COUNT(*) as total_orders,
  SUM(calculatedAmount + carUsageAmount) as total_engineer,
  SUM(organizationPayment + carUsageAmount) as total_org,
  SUM(profit) as total_profit
FROM orders
WHERE status = 'completed'
  AND completionDate >= '2025-10-01'
  AND completionDate < '2025-11-01';

-- Ожидается: 
-- total_orders=5
-- total_engineer=44050
-- total_org=50700
-- total_profit=6650
```

### Проверка прибыли по организациям:
```sql
SELECT 
  org.name,
  COUNT(o.id) as orders,
  SUM(o.profit) as profit
FROM orders o
JOIN organization org ON o.organizationId = org.id
WHERE o.status = 'completed'
  AND o.completionDate >= '2025-10-01'
  AND o.completionDate < '2025-11-01'
GROUP BY org.name
ORDER BY profit DESC;

-- Ожидается:
-- ООО "Альфа": 3,600₽
-- ООО "Гамма": 2,000₽
-- ООО "Бета": 1,050₽
```

---

## ✅ РЕЗЮМЕ

**Вся статистика рассчитывается в реальном времени из одной таблицы `orders`:**

✅ Нет промежуточных таблиц  
✅ Нет кэширования  
✅ Нет рассинхронизации  
✅ Всегда актуальные данные  
✅ Полная детализация расчётов  
✅ Прозрачность для аудита  
✅ Простая поддержка  

**Одна таблица → Одна истина!** 🎯

