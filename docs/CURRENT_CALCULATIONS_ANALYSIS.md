# –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö —Ä–∞—Å—á—ë—Ç–æ–≤

## üìä –î–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

### –ó–∞–∫–∞–∑ #8 (–õ–æ–∫–∞–ª—å–Ω—ã–π –°–µ—Ä–≤–∏—Å)

```json
{
  "regularHours": 2,
  "overtimeHours": 2,
  "calculatedAmount": 3800,
  "carUsageAmount": 2000,
  "organizationPayment": 6000,
  "engineerBaseRate": 700,
  "engineerOvertimeRate": 1200,
  "organizationBaseRate": 1200,
  "organizationOvertimeMultiplier": 1.5,
  "regularPayment": 1400,
  "overtimePayment": 2400,
  "organizationRegularPayment": 2400,
  "organizationOvertimePayment": 3600,
  "profit": 2200
}
```

### –ó–∞–∫–∞–∑ #7 (–í–∏—Å—Ç–µ–∫—Å)

```json
{
  "regularHours": 2,
  "overtimeHours": 2,
  "calculatedAmount": 3600,
  "carUsageAmount": 2000,
  "organizationPayment": 4500,
  "engineerBaseRate": 600,
  "engineerOvertimeRate": 1200,
  "organizationBaseRate": 900,
  "organizationOvertimeMultiplier": 1.5,
  "regularPayment": 1200,
  "overtimePayment": 2400,
  "organizationRegularPayment": 1800,
  "organizationOvertimePayment": 2700,
  "profit": 900
}
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–æ–≤

### –ó–∞–∫–∞–∑ #8 - –õ–æ–∫–∞–ª—å–Ω—ã–π –°–µ—Ä–≤–∏—Å

#### –û–ø–ª–∞—Ç–∞ –∏–Ω–∂–µ–Ω–µ—Ä—É:

```
regularPayment = 2 —á √ó 700 ‚ÇΩ/—á = 1,400 ‚ÇΩ ‚úÖ
overtimePayment = 2 —á √ó 1,200 ‚ÇΩ/—á = 2,400 ‚ÇΩ ‚úÖ
calculatedAmount = 1,400 + 2,400 = 3,800 ‚ÇΩ ‚úÖ
+ carUsageAmount = 2,000 ‚ÇΩ
–ò–¢–û–ì–û –∏–Ω–∂–µ–Ω–µ—Ä—É: 5,800 ‚ÇΩ
```

#### –û–ø–ª–∞—Ç–∞ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:

```
organizationRegularPayment = 2 —á √ó 1,200 ‚ÇΩ/—á = 2,400 ‚ÇΩ ‚úÖ
organizationOvertimePayment = 2 —á √ó 1,200 ‚ÇΩ/—á √ó 1.5 = 3,600 ‚ÇΩ ‚úÖ
organizationPayment = 2,400 + 3,600 = 6,000 ‚ÇΩ ‚úÖ
+ carUsageAmount = 2,000 ‚ÇΩ
–ò–¢–û–ì–û –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: 8,000 ‚ÇΩ
```

#### –ü—Ä–∏–±—ã–ª—å:

```
profit = 6,000 - 3,800 = 2,200 ‚ÇΩ ‚úÖ
```

**‚úÖ –í–°–ï –†–ê–°–ß–Å–¢–´ –ü–†–ê–í–ò–õ–¨–ù–´–ï!**

---

### –ó–∞–∫–∞–∑ #7 - –í–∏—Å—Ç–µ–∫—Å

#### –û–ø–ª–∞—Ç–∞ –∏–Ω–∂–µ–Ω–µ—Ä—É:

```
regularPayment = 2 —á √ó 600 ‚ÇΩ/—á = 1,200 ‚ÇΩ ‚úÖ
overtimePayment = 2 —á √ó 1,200 ‚ÇΩ/—á = 2,400 ‚ÇΩ ‚úÖ
calculatedAmount = 1,200 + 2,400 = 3,600 ‚ÇΩ ‚úÖ
+ carUsageAmount = 2,000 ‚ÇΩ
–ò–¢–û–ì–û –∏–Ω–∂–µ–Ω–µ—Ä—É: 5,600 ‚ÇΩ
```

#### –û–ø–ª–∞—Ç–∞ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:

```
organizationRegularPayment = 2 —á √ó 900 ‚ÇΩ/—á = 1,800 ‚ÇΩ ‚úÖ
organizationOvertimePayment = 2 —á √ó 900 ‚ÇΩ/—á √ó 1.5 = 2,700 ‚ÇΩ ‚úÖ
organizationPayment = 1,800 + 2,700 = 4,500 ‚ÇΩ ‚úÖ
+ carUsageAmount = 2,000 ‚ÇΩ
–ò–¢–û–ì–û –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: 6,500 ‚ÇΩ
```

#### –ü—Ä–∏–±—ã–ª—å:

```
profit = 4,500 - 3,600 = 900 ‚ÇΩ ‚úÖ
```

**‚úÖ –í–°–ï –†–ê–°–ß–Å–¢–´ –ü–†–ê–í–ò–õ–¨–ù–´–ï!**

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º

### –õ–æ–∫–∞–ª—å–Ω—ã–π –°–µ—Ä–≤–∏—Å (–ó–∞–∫–∞–∑ #8):

```json
{
  "organizationName": "–õ–æ–∫–∞–ª—å–Ω—ã–π –°–µ—Ä–≤–∏—Å",
  "totalRevenue": 6000, // ‚úÖ organizationPayment
  "totalCosts": 3800, // ‚úÖ calculatedAmount
  "totalProfit": 2200, // ‚úÖ 6,000 - 3,800
  "profitMargin": 36.67, // ‚úÖ (2,200 / 6,000) √ó 100
  "totalOrders": 1,
  "totalHours": 4, // ‚úÖ 2 + 2
  "averageOrderValue": 6000
}
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!**

### –í–∏—Å—Ç–µ–∫—Å (–ó–∞–∫–∞–∑ #7):

```json
{
  "organizationName": "–í–∏—Å—Ç–µ–∫—Å",
  "totalRevenue": 4500, // ‚úÖ organizationPayment
  "totalCosts": 3600, // ‚úÖ calculatedAmount
  "totalProfit": 900, // ‚úÖ 4,500 - 3,600
  "profitMargin": 20, // ‚úÖ (900 / 4,500) √ó 100
  "totalOrders": 1,
  "totalHours": 4, // ‚úÖ 2 + 2
  "averageOrderValue": 4500
}
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!**

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ

### 1. **`agentEarnings: []` - –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤**

**–ü—Ä–∏—á–∏–Ω–∞:** `leftJoin` —Å `assignedEngineer` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –±–∞–∑–µ:

```json
"assignedEngineer": null,  // ‚ùå relation –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
"assignedEngineerId": 4    // ‚úÖ –Ω–æ ID –µ—Å—Ç—å!
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `innerJoin` –Ω–∞–ø—Ä—è–º—É—é —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ `engineer` –∏ `user`:

```typescript
.innerJoin('engineer', 'engineer', 'order.assignedEngineerId = engineer.id')
.innerJoin('user', 'user', 'engineer.userId = user.id')
```

### 2. **`totalEarnings: 0` –∏ `totalOrders: 0`**

–≠—Ç–∏ –ø–æ–ª—è —Å—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `agentEarnings`, –∫–æ—Ç–æ—Ä—ã–π –ø—É—Å—Ç–æ–π. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø.1 –æ–Ω–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–∂–∏–¥–∞–µ—Ç—Å—è:

```json
{
  "year": 2025,
  "month": 10,
  "agentEarnings": [
    {
      "agentId": 4,
      "agentName": "–ò–Ω–∂–µ–Ω–µ—Ä –°—Ç–∞–≤—Ä–æ–ø–æ–ª—å",
      "totalEarnings": 11400, // (3,800+2,000) + (3,600+2,000)
      "completedOrders": 2,
      "averageOrderValue": 5700
    }
  ],
  "organizationEarnings": [
    {
      "organizationName": "–õ–æ–∫–∞–ª—å–Ω—ã–π –°–µ—Ä–≤–∏—Å",
      "totalRevenue": 6000,
      "totalCosts": 3800,
      "totalProfit": 2200,
      "profitMargin": 36.67,
      "totalOrders": 1,
      "totalHours": 4
    },
    {
      "organizationName": "–í–∏—Å—Ç–µ–∫—Å",
      "totalRevenue": 4500,
      "totalCosts": 3600,
      "totalProfit": 900,
      "profitMargin": 20,
      "totalOrders": 1,
      "totalHours": 4
    }
  ],
  "overtimeStatistics": [
    {
      "agentId": 4,
      "agentName": "–ò–Ω–∂–µ–Ω–µ—Ä –°—Ç–∞–≤—Ä–æ–ø–æ–ª—å",
      "overtimeHours": 4,
      "regularHours": 4,
      "totalHours": 8,
      "overtimePercentage": 50
    }
  ],
  "totalEarnings": 11400, // ‚úÖ –°—É–º–º–∞ –ø–æ –≤—Å–µ–º –∏–Ω–∂–µ–Ω–µ—Ä–∞–º
  "totalOrders": 2, // ‚úÖ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤
  "totalOvertimeHours": 4
}
```

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –†–∞—Å—á—ë—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ? ‚úÖ –î–ê!

- ‚úÖ –û–ø–ª–∞—Ç–∞ –∏–Ω–∂–µ–Ω–µ—Ä–∞–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –≤–µ—Ä–Ω–æ
- ‚úÖ –û–ø–ª–∞—Ç–∞ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –≤–µ—Ä–Ω–æ
- ‚úÖ –ü—Ä–∏–±—ã–ª—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –≤–µ—Ä–Ω–æ
- ‚úÖ –í—Å–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç? ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û

- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç engineerId –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏)
- ‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞–º (`agentEarnings`) –±—ã–ª–∞ –ø—É—Å—Ç–æ–π ‚Üí **–ò–°–ü–†–ê–í–õ–ï–ù–û**

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. ‚úÖ –ó–∞–º–µ–Ω–∏–ª `leftJoin` –Ω–∞ `innerJoin` –≤ `getAgentEarningsData`
2. ‚úÖ –ó–∞–º–µ–Ω–∏–ª `leftJoin` –Ω–∞ `innerJoin` –≤ `getOvertimeStatisticsData`
3. ‚úÖ –î–æ–±–∞–≤–∏–ª —É—Å–ª–æ–≤–∏–µ `order.assignedEngineerId IS NOT NULL`

---

## üìã –ò—Ç–æ–≥–æ

**–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–æ–≤ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø!** ‚úÖ

–í—Å–µ —Ñ–æ—Ä–º—É–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

- ‚úÖ –°—Ç–∞–≤–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ –ü—Ä–∏–±—ã–ª—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤–µ—Ä–Ω–æ
- ‚úÖ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞–º –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç!** üöÄ
