# 🚀 Быстрый старт: Система выплат зарплаты

## 📋 Что это?

Система для отслеживания фактических выплат зарплаты инженерам, включающая:

- **Выплаты** - история всех платежей (зарплата, авансы, премии)
- **Балансы** - сколько начислено vs сколько выплачено
- **Частичные выплаты** - можно платить частями
- **Авансы** - выплаты вперед текущего месяца

---

## 🎯 Основные сценарии

### Сценарий 1: Обычная выплата зарплаты

**Ситуация:** Инженеру начислено 80,000₽ за сентябрь, нужно выплатить.

**Действия:**

1. Перейти на страницу "Расчеты зарплаты"
2. Найти начисление инженера за сентябрь
3. Нажать "Выплатить"
4. Заполнить форму:
   - Сумма: 80,000₽
   - Тип: Зарплата
   - Способ: Банковский перевод
   - Дата: 15.10.2025
5. Сохранить

**Результат:**

- ✅ Создана выплата на 80,000₽
- ✅ Статус начисления изменился на "Оплачено"
- ✅ Баланс инженера: 0₽ (все погашено)

---

### Сценарий 2: Выплата аванса

**Ситуация:** 10 октября инженер просит выплатить аванс 20,000₽ за текущий месяц.

**Действия:**

1. Перейти в "Выплаты" → "Добавить выплату"
2. Заполнить форму:
   - Инженер: Иванов Иван
   - Сумма: 20,000₽
   - Тип: **Аванс**
   - Период: Октябрь 2025
   - Дата: 10.10.2025
3. Сохранить

**Результат:**

- ✅ Создана выплата-аванс
- ⚠️ Начисление за октябрь еще не создано
- 💡 При создании начисления за октябрь нужно будет доплатить остаток

**Пример:**

```
10.10.2025: Аванс 20,000₽
01.11.2025: Начисление за октябрь 75,000₽
           Баланс: +55,000₽ (требуется доплатить)
15.11.2025: Выплата остатка 55,000₽
           Баланс: 0₽
```

---

### Сценарий 3: Частичная выплата

**Ситуация:** Начислено 80,000₽, но компания может выплатить только 50,000₽ сейчас.

**Действия:**

1. Создать первую выплату на 50,000₽
2. Позже создать вторую выплату на 30,000₽

**Результат:**

- ✅ Две выплаты по 50,000₽ и 30,000₽
- ✅ Статус начисления "Оплачено" (после второй выплаты)
- ✅ Баланс: 0₽

---

### Сценарий 4: Обнаружена переплата

**Ситуация:** Начислено 70,000₽, но по ошибке выплатили 80,000₽.

**Что происходит:**

- ⚠️ Баланс инженера: -10,000₽ (переплата)
- 💡 При следующей выплате учесть переплату

**Действия для исправления:**

1. Вариант А: Создать корректировку на -10,000₽
2. Вариант Б: В следующем месяце выплатить на 10,000₽ меньше

**Пример:**

```
Сентябрь: Начислено 70,000₽, выплачено 80,000₽
         Баланс: -10,000₽

Октябрь: Начислено 75,000₽
         Выплачено 65,000₽ (с учетом переплаты)
         Баланс: 0₽
```

---

## 🖥️ Интерфейс

### Страница "Балансы инженеров"

```
┌─────────────────────────────────────────┐
│  Иванов Иван                 К выплате  │
│  ───────────────────────────────────── │
│  Начислено:        240,000₽             │
│  Выплачено:        220,000₽             │
│  Баланс:            20,000₽             │
│                                         │
│  Последнее начисление: 01.10.2025      │
│  Последняя выплата: 15.09.2025         │
└─────────────────────────────────────────┘
```

### Страница выплат инженера

```
┌─────────────────────────────────────────┐
│  История выплат          [+ Добавить]   │
│  ───────────────────────────────────── │
│  75,000₽  Зарплата                      │
│  15.10.2025  Перевод  Сентябрь 2025    │
│  Зарплата за сентябрь                   │
│                               [✏️] [🗑️]  │
│  ───────────────────────────────────── │
│  20,000₽  Аванс                         │
│  10.10.2025  Перевод  Октябрь 2025     │
│  Аванс за октябрь                       │
│                               [✏️] [🗑️]  │
└─────────────────────────────────────────┘
```

---

## 🔍 Как проверить баланс инженера?

### Способ 1: Через API

```bash
curl -X GET "http://localhost:3000/api/salary-payments/balance/5" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Ответ:**

```json
{
  "engineerName": "Иванов Иван",
  "totalAccrued": 240000,
  "totalPaid": 220000,
  "balance": 20000,
  "lastAccrualDate": "2025-10-01",
  "lastPaymentDate": "2025-09-15"
}
```

### Способ 2: Через UI

1. Открыть "Расчеты зарплаты"
2. Нажать на инженера
3. Посмотреть карточку баланса

---

## 💡 Полезные советы

### 1. Регулярно проверяйте балансы

Открывайте страницу "Балансы инженеров" и следите за:

- ⚠️ Большими положительными балансами (давно не платили)
- ⚠️ Отрицательными балансами (переплаты)

### 2. Указывайте комментарии

При создании выплаты всегда указывайте:

- За какой период
- Номер платежного документа
- Дополнительные детали

### 3. Используйте правильный тип выплаты

- `Зарплата` - для обычных выплат по начислению
- `Аванс` - для выплат вперед
- `Премия` - для дополнительных поощрений
- `Корректировка` - для исправления ошибок

### 4. Проверяйте статус начисления

После выплаты статус начисления должен стать "Оплачено". Если этого не произошло - возможно, выплачена не вся сумма.

---

## ⚠️ Частые ошибки

### Ошибка 1: Баланс не обновляется

**Причина:** Выплата не привязана к начислению или статус не "completed"

**Решение:**

1. Проверить статус выплаты
2. Убедиться, что выплата сохранена
3. Обновить страницу

### Ошибка 2: Начисление не меняет статус на "Оплачено"

**Причина:** Выплачено меньше, чем начислено

**Решение:**

1. Проверить сумму начисления
2. Проверить сумму всех выплат по этому начислению
3. Доплатить недостающую сумму

### Ошибка 3: Отрицательный баланс

**Причина:** Переплата инженеру

**Решение:**

1. Проверить все выплаты
2. Создать корректировку или учесть при следующей выплате
3. При необходимости - попросить инженера вернуть переплату

---

## 📊 Отчеты

### Отчет 1: Кому должны

```sql
SELECT
  e.id,
  u.first_name,
  u.last_name,
  eb.balance
FROM engineer_balances eb
JOIN engineers e ON e.id = eb.engineer_id
JOIN users u ON u.id = e.user_id
WHERE eb.balance > 0
ORDER BY eb.balance DESC;
```

### Отчет 2: Выплаты за месяц

```sql
SELECT
  u.first_name,
  u.last_name,
  SUM(sp.amount) as total_paid
FROM salary_payments sp
JOIN engineers e ON e.id = sp.engineer_id
JOIN users u ON u.id = e.user_id
WHERE sp.payment_date >= '2025-10-01'
  AND sp.payment_date < '2025-11-01'
  AND sp.status = 'completed'
GROUP BY e.id, u.first_name, u.last_name;
```

---

## 🎓 Учебное видео (TODO)

1. Как создать выплату
2. Как выплатить аванс
3. Как проверить баланс
4. Как исправить ошибку

---

## ❓ FAQ

**Q: Можно ли удалить выплату?**
A: Да, но это пересчитает баланс и может изменить статус начисления обратно.

**Q: Можно ли редактировать выплату?**
A: Да, все изменения автоматически пересчитают баланс.

**Q: Что если выплатили больше, чем начислено?**
A: Баланс станет отрицательным. Учтите переплату при следующей выплате.

**Q: Как учитывать НДФЛ и другие удержания?**
A: Создавайте выплату на сумму "на руки", а в комментарии указывайте детали удержаний.

**Q: Можно ли выплатить аванс за следующий месяц?**
A: Да, укажите тип "Аванс" и нужный месяц/год.

---

**Готово! Теперь можно управлять выплатами зарплаты.** 🎉
